name: Update File Mapping

on:
  push:
    paths:
      - "Content/0-Hand-Storage/**"  # 当此目录下文件增、删、改都会触发

jobs:
  update-mapping:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Setup Python environment
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    # 3. Generate Mapping File (auto-remove deleted file entries)
    - name: Generate Mapping File
      run: |
        python3 <<EOF
        import os
        import time
        import json

        base_path = "./Content/0-Hand-Storage"

        # 初始化结构，每次都重建（确保删除生效）
        data = {
            "Content": {
                "0-Hand-Storage": {}
            },
            "Information": {}
        }

        # 获取当前文件夹内容（真实源）
        files = [
            f for f in os.listdir(base_path)
            if os.path.isfile(os.path.join(base_path, f))
        ]

        # 填充文件映射
        for file in files:
            path = os.path.join(base_path, file)
            timestamp = int(os.path.getmtime(path))
            data["Content"]["0-Hand-Storage"][file] = f"{file}?t={timestamp}"

        # 填充统计信息
        data["Information"]["TotalNum"] = len(files)
        data["Information"]["TotalSize"] = sum(
            os.path.getsize(os.path.join(base_path, f)) for f in files
        )
        data["Information"]["Timestamp"] = int(time.time())

        # 重新写入 Filetree.json
        with open("./Filetree.json", "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
            f.write("\n")
        EOF

    # 4. Commit and push changes
    - name: Commit and Push Changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add Filetree.json
        if ! git diff --cached --quiet; then
          git commit -m "Auto-update file mapping"
          git push
        else
          echo "No changes to commit."
        fi
